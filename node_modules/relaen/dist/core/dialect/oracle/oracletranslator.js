"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.OracleTranslator = void 0;
const entityfactory_1 = require("../../entityfactory");
const error_1 = require("../../message/error");
const relaenmanager_1 = require("../../relaenmanager");
const translator_1 = require("../../translator");
const types_1 = require("../../types");
/**
 * mssql 翻译器
 */
class OracleTranslator extends translator_1.Translator {
    /**
     * 产生查询sql
     * @returns     数组[sql,linkMap,values]
     *              其中：linkMap为该translator的linkNameMap，values为查询参数值
     */
    getQuerySql() {
        switch (this.sqlType) {
            case types_1.EQueryType.SELECT:
                return this.getSelectSql();
            case types_1.EQueryType.DELETE:
                return this.getDeleteSql(true);
        }
    }
    /**
     * 生成增删改sql
     * @param notNeedAlias -      不需要别名
     * @returns 数组[sql,linkMap,values]
     *          其中：linkMap为该translator的linkNameMap，values为查询参数值
     */
    getDeleteSql(notNeedAlias) {
        if (!this.whereObject && !relaenmanager_1.RelaenManager.fullTableOperation) {
            throw new error_1.RelaenError("0120");
        }
        const arr = [];
        arr.push('DELETE ' + (notNeedAlias ? '' : 't0 ') + ' FROM ' + this.mainEntityCfg.getTableName(true) + ' t0');
        //处理主表和join表
        const joinArr = [];
        for (const o of this.linkNameMap) {
            if (!o[1]['from']) {
                continue;
            }
            const orm = entityfactory_1.EntityFactory.getEntityConfig(o[1]['entity']);
            const al1 = o[1]['alias'];
            const al2 = this.linkNameMap.get(o[1]['from'])['alias'];
            const co = o[1]['co'];
            joinArr.push('LEFT JOIN ' + orm.getTableName(true) + ' ' + al1 + ' on ' + al2 + '.' + co.name + '=' + al1 + '.' + co.refName);
        }
        //存在关联关系
        if (joinArr.length > 0) {
            arr.push('WHERE EXISTS (SELECT ' + this.mainEntityCfg.getIdName() + ' FROM ' + this.mainEntityCfg.getTableName(true) + joinArr.join(',') + ' WHERE ' + this.whereObject[0] + ')');
        }
        else {
            arr.push('WHERE ' + this.whereObject[0]);
        }
        return [arr.join(' '), this.linkNameMap, this.whereObject ? this.whereObject[1] : undefined];
    }
}
exports.OracleTranslator = OracleTranslator;
//# sourceMappingURL=oracletranslator.js.map